<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="google-site-verification" content="2hbghMg_sHTSPhxlcIJ1haJpCEc1dp_fOy6qRl47WIM" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA DE GESTION DE FACTURAS</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- jsPDF para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ESTILOS GENERALES */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* PANTALLA DE LOGIN */
        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px 20px;
            max-width: 400px;
            width: 95%;
            text-align: center;
            margin-top: 10vh;
        }
        
        .login-container h1 {
            color: var(--dark);
            margin-bottom: 25px;
            font-size: 1.5rem;
        }
        
        .login-container i {
            font-size: 40px;
            color: var(--secondary);
            margin-bottom: 15px;
        }
        
        /* TARJETAS Y FORMULARIOS */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 20px 15px;
            margin-bottom: 20px;
        }
        
        h1, h2, h3 {
            color: var(--dark);
            margin-bottom: 15px;
        }
        
        h1 {
            font-size: 1.8rem;
            text-align: center;
            margin-bottom: 20px;
            color: white;
            padding: 0 10px;
        }
        
        h2 {
            font-size: 1.4rem;
            border-bottom: 2px solid var(--light);
            padding-bottom: 8px;
        }
        
        /* FORMULARIOS */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }
        
        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* BOTONES */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-primary:hover, .btn-primary:active {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-pendiente {
            background: var(--danger);
            color: white;
        }
        
        .btn-cancelado {
            background: var(--success);
            color: white;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 14px;
            width: auto;
        }
        
        /* TABLAS - OPTIMIZADA PARA MÓVIL */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            -webkit-overflow-scrolling: touch;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }
        
        th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            position: sticky;
            left: 0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        /* MODALES - OPTIMIZADOS PARA MÓVIL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 10px;
        }
        
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            box-sizing: border-box;
        }
        
        /* GRID ADAPTATIVO */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        /* ESTADOS */
        .hidden {
            display: none !important;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            font-size: 16px;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* HEADER DE MES - OPTIMIZADO PARA MÓVIL */
        .mes-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .mes-title {
            color: #2c3e50;
            margin: 0;
            font-size: 1.2rem;
        }
        
        .mes-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .totales {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }
        
        .total-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .total-main {
            font-weight: bold;
            font-size: 1em;
            border-top: 1px dashed #ccc;
            padding-top: 8px;
            margin-top: 8px;
        }
        
        /* MEJORAS ESPECÍFICAS PARA MÓVIL */
        .mobile-optimized {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            touch-action: manipulation;
        }
        
        /* BOTONES TÁCTILES MÁS GRANDES EN MÓVIL */
        @media (max-width: 768px) {
            .btn {
                min-height: 44px;
            }
            
            input, select {
                font-size: 16px; /* Previene zoom en iOS */
            }
        }
        
        /* ESTILOS PARA PANTALLAS MUY PEQUEÑAS */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .card {
                padding: 15px 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            h2 {
                font-size: 1.2rem;
            }
            
            .mes-title {
                font-size: 1.1rem;
            }
            
            .btn-sm {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .modal-content {
                padding: 15px;
                margin: 5% auto;
            }
        }
        
        /* ESTILOS PARA TABLETS Y PANTALLAS MÁS GRANDES */
        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .mes-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            
            .mes-actions {
                justify-content: flex-end;
            }
            
            .btn {
                width: auto;
            }
        }
        
        /* MEJORA DE SCROLL EN MÓVIL */
        .scroll-mobile {
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
        }
    </style>
</head>
<body class="mobile-optimized">
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="login-container">
        <i class="fas fa-lock"></i>
        <h1>Acceso al Sistema</h1>
        <div class="form-group">
            <label for="passwordInput">Contraseña:</label>
            <input type="password" id="passwordInput" placeholder="Ingresa la contraseña">
        </div>
        <button class="btn btn-primary" id="btnLogin">
            <i class="fas fa-sign-in-alt"></i> Ingresar
        </button>
        <div id="loginError" class="alert alert-error hidden" style="margin-top: 15px;">
            Contraseña incorrecta. Intenta nuevamente.
        </div>
    </div>
    
    <!-- Sistema de Facturas (oculto inicialmente) -->
    <div id="appContainer" class="container hidden scroll-mobile">
        <h1><i class="fas fa-file-invoice-dollar"></i> Sistema de Gestión de Facturas</h1>
        
        <!-- Mensajes de alerta -->
        <div id="alertContainer"></div>
        
        <!-- Formulario para Nueva Factura -->
        <div class="card">
            <h2><i class="fas fa-plus-circle"></i> Nueva Factura</h2>
            
            <div class="form-group">
                <label for="mes"><i class="fas fa-calendar-alt"></i> Mes de Facturación</label>
                <input type="month" id="mes" required>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="nro">Número de Orden</label>
                    <input type="number" id="nro" min="1" placeholder="Ingresa el número de orden" required>
                    <small>Define el orden de la factura (1, 2, 3, ...)</small>
                </div>
                
                <div class="form-group">
                    <label for="empresa">Empresa</label>
                    <input type="text" id="empresa" placeholder="Nombre de la empresa" required>
                </div>
                
                <div class="form-group">
                    <label for="fecha">Fecha de Factura</label>
                    <input type="date" id="fecha" required>
                </div>
                
                <div class="form-group">
                    <label for="nroFactura">Número de Factura</label>
                    <input type="text" id="nroFactura" placeholder="Número completo" required>
                </div>
                
                <div class="form-group">
                    <label for="monto">Monto (Bs)</label>
                    <input type="number" id="monto" step="0.01" placeholder="0.00" required>
                </div>
            </div>
            
            <button class="btn btn-primary" id="btnAgregar">
                <i class="fas fa-plus"></i> Agregar Factura
            </button>
        </div>
        
        <!-- Lista de Facturas -->
        <div class="card">
            <h2><i class="fas fa-list"></i> Facturas Registradas</h2>
            <div id="listaFacturas">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Cargando facturas...
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Confirmar Eliminación -->
    <div id="modalEliminar" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-trash"></i> Confirmar Eliminación</h3>
            <p id="modalEliminarTexto">¿Estás seguro de que deseas eliminar esta factura?</p>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn" onclick="cerrarModal('modalEliminar')" style="width: auto;">Cancelar</button>
                <button class="btn btn-danger" id="btnConfirmarEliminar" style="width: auto;">Eliminar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Confirmar Cancelación -->
    <div id="modalCancelacion" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-check-circle"></i> Confirmar Cancelación</h3>
            <p id="modalCancelacionTexto">¿Estás seguro de que este mes ha sido cancelado?</p>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn" onclick="cerrarModal('modalCancelacion')" style="width: auto;">Cancelar</button>
                <button class="btn btn-success" id="btnConfirmarCancelacion" style="width: auto;">Sí, Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Exportar -->
    <div id="modalExportar" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-download"></i> Exportar Facturas</h3>
            <p id="modalExportarTexto">Selecciona el formato para descargar:</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-direction: column;">
                <button class="btn btn-danger" id="btnExportarPDF">
                    <i class="fas fa-file-pdf"></i> Exportar a PDF
                </button>
                <button class="btn btn-primary" id="btnExportarWord">
                    <i class="fas fa-file-word"></i> Exportar a Word
                </button>
            </div>
            <div style="margin-top: 15px; text-align: center;">
                <button class="btn" onclick="cerrarModal('modalExportar')" style="width: auto;">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURACIÓN DE FIREBASE
        // =============================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyBokBK_PYvpvpFX6t0GW4sDLr31QdVklp8",
            authDomain: "sistemas-facturas.firebaseapp.com",
            projectId: "sistemas-facturas",
            storageBucket: "sistemas-facturas.firebasestorage.app",
            messagingSenderId: "802542240199",
            appId: "1:802542240199:web:71d2ba2b68b4b42d2e99e2"
        };
        
        // Inicializar Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('✅ Firebase inicializado correctamente');
        } catch (error) {
            console.error('❌ Error inicializando Firebase:', error);
            mostrarAlerta('Error al conectar con la base de datos', 'error');
        }
        
        const db = firebase.firestore();
        const { jsPDF } = window.jspdf;
        
        // =============================================
        // VARIABLES GLOBALES
        // =============================================
        let facturas = [];
        let facturaAEliminar = null;
        let mesACancelar = null;
        let mesAExportar = null;
        const PASSWORD = "Churqui123"; // Contraseña de acceso
        
        // =============================================
        // FUNCIONES DE AUTENTICACIÓN
        // =============================================
        
        // Verificar contraseña
        function verificarPassword() {
            const passwordInput = document.getElementById('passwordInput').value;
            const loginError = document.getElementById('loginError');
            
            if (passwordInput === PASSWORD) {
                // Contraseña correcta, mostrar la aplicación
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                inicializarAplicacion();
            } else {
                // Contraseña incorrecta
                loginError.classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }
        
        // Inicializar la aplicación después del login
        function inicializarAplicacion() {
            // Establecer fecha actual por defecto
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fecha').value = hoy;
            
            // Establecer mes actual por defecto
            const mesActual = new Date().toISOString().slice(0, 7);
            document.getElementById('mes').value = mesActual;
            
            // Actualizar número de orden al cambiar mes
            document.getElementById('mes').addEventListener('change', actualizarSugerenciaNumero);
            
            // Event listeners
            document.getElementById('btnAgregar').addEventListener('click', agregarFactura);
            document.getElementById('btnConfirmarEliminar').addEventListener('click', function() {
                if (facturaAEliminar) {
                    eliminarFactura(facturaAEliminar);
                }
            });
            document.getElementById('btnConfirmarCancelacion').addEventListener('click', function() {
                if (mesACancelar) {
                    cancelarMes(mesACancelar);
                }
            });
            
            // Event listeners para exportar
            document.getElementById('btnExportarPDF').addEventListener('click', function() {
                if (mesAExportar) {
                    exportarAPDF(mesAExportar);
                }
            });
            document.getElementById('btnExportarWord').addEventListener('click', function() {
                if (mesAExportar) {
                    exportarAWord(mesAExportar);
                }
            });
            
            // Cargar facturas al iniciar
            cargarFacturas();
            actualizarSugerenciaNumero();
            
            // Cerrar modales al hacer clic fuera
            window.addEventListener('click', function(event) {
                if (event.target === document.getElementById('modalEliminar')) {
                    cerrarModal('modalEliminar');
                }
                if (event.target === document.getElementById('modalCancelacion')) {
                    cerrarModal('modalCancelacion');
                }
                if (event.target === document.getElementById('modalExportar')) {
                    cerrarModal('modalExportar');
                }
            });
        }
        
        // =============================================
        // FUNCIONES PRINCIPALES
        // =============================================
        
        // Mostrar alertas
        function mostrarAlerta(mensaje, tipo = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = tipo === 'success' ? 'alert-success' : 'alert-error';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass}`;
            alertDiv.innerHTML = `
                <strong>${tipo === 'success' ? 'Éxito!' : 'Error!'}</strong> ${mensaje}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto-eliminar después de 5 segundos
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // Cargar facturas desde Firebase
        async function cargarFacturas() {
            try {
                const contenedor = document.getElementById('listaFacturas');
                contenedor.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Cargando facturas...</div>';
                
                // Cargar facturas
                const snapshotFacturas = await db.collection('facturas').orderBy('timestamp', 'desc').get();
                facturas = [];
                
                snapshotFacturas.forEach(doc => {
                    const data = doc.data();
                    facturas.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                console.log('✅ Facturas cargadas:', facturas.length);
                mostrarFacturas();
                
            } catch (error) {
                console.error('❌ Error cargando facturas:', error);
                mostrarAlerta('Error al cargar las facturas: ' + error.message, 'error');
            }
        }
        
        // Mostrar facturas en la tabla
        function mostrarFacturas() {
            const contenedor = document.getElementById('listaFacturas');
            
            if (facturas.length === 0) {
                contenedor.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #666;">
                        <i class="fas fa-inbox" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <h3>No hay facturas registradas</h3>
                        <p>Agrega tu primera factura usando el formulario superior</p>
                    </div>
                `;
                return;
            }
            
            // Agrupar facturas por mes
            const facturasPorMes = {};
            facturas.forEach(factura => {
                if (!facturasPorMes[factura.mes]) {
                    facturasPorMes[factura.mes] = {
                        facturas: [],
                        cancelado: false
                    };
                }
                facturasPorMes[factura.mes].facturas.push(factura);
            });
            
            let html = '';
            
            // Ordenar meses de más reciente a más antiguo
            const meses = Object.keys(facturasPorMes).sort().reverse();
            
            meses.forEach(mes => {
                const datosMes = facturasPorMes[mes];
                const facturasDelMes = datosMes.facturas;
                const total = facturasDelMes.reduce((sum, factura) => sum + parseFloat(factura.monto), 0);
                const seisPorciento = total * 0.06;
                const totalGeneral =  seisPorciento;
                
                // Ordenar facturas por número de orden (ingresado por el usuario)
                facturasDelMes.sort((a, b) => parseInt(a.nro) - parseInt(b.nro));
                
                html += `
                    <div class="mes-group" style="margin-bottom: 25px; border: 2px solid #eee; border-radius: 10px; padding: 15px;">
                        <div class="mes-header">
                            <h3 class="mes-title">${formatearMes(mes)}</h3>
                            <div class="mes-actions">
                                ${datosMes.cancelado ? 
                                    `<button class="btn btn-cancelado btn-sm" disabled>
                                        <i class="fas fa-check-circle"></i> Cancelado
                                    </button>` : 
                                    `<button class="btn btn-pendiente btn-sm" onclick="confirmarCancelacion('${mes}')">
                                        <i class="fas fa-money-bill-wave"></i> Pendiente
                                    </button>`
                                }
                                <button class="btn btn-info btn-sm" onclick="toggleDetalles('${mes}')">
                                    <i class="fas fa-list"></i> Detalles
                                </button>
                                <button class="btn btn-success btn-sm" onclick="mostrarModalExportar('${mes}')">
                                    <i class="fas fa-download"></i> Descargar
                                </button>
                            </div>
                        </div>
                        
                        <div class="totales">
                            <div class="total-line">
                                <span>Subtotal:</span>
                                <span><strong>${formatearMoneda(total)}</strong></span>
                            </div>
                            <div class="total-line">
                                <span>6% sobre el total:</span>
                                <span>${formatearMoneda(seisPorciento)}</span>
                            </div>
                            <div class="total-line total-main">
                                <span>TOTAL GENERAL:</span>
                                <span>${formatearMoneda(totalGeneral)}</span>
                            </div>
                        </div>
                        
                        <div id="detalles-${mes}" class="hidden">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nro</th>
                                            <th>Empresa</th>
                                            <th>Fecha</th>
                                            <th>N° Factura</th>
                                            <th>Monto (Bs)</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                facturasDelMes.forEach(factura => {
                    html += `
                        <tr>
                            <td>${factura.nro}</td>
                            <td>${factura.empresa}</td>
                            <td>${factura.fecha}</td>
                            <td>${factura.nroFactura}</td>
                            <td style="font-weight: bold;">${formatearMoneda(factura.monto)}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="confirmarEliminar('${factura.id}', '${factura.nro}', '${mes}')">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            contenedor.innerHTML = html;
        }
        
        // Alternar visibilidad de detalles
        function toggleDetalles(mes) {
            const detalles = document.getElementById(`detalles-${mes}`);
            detalles.classList.toggle('hidden');
        }
        
        // Agregar nueva factura
        async function agregarFactura() {
            const mes = document.getElementById('mes').value;
            const nro = document.getElementById('nro').value;
            const empresa = document.getElementById('empresa').value;
            const fecha = document.getElementById('fecha').value;
            const nroFactura = document.getElementById('nroFactura').value;
            const monto = document.getElementById('monto').value;
            
            // Validaciones
            if (!mes || !nro || !empresa || !fecha || !nroFactura || !monto) {
                mostrarAlerta('Por favor, completa todos los campos', 'error');
                return;
            }
            
            if (parseInt(nro) <= 0) {
                mostrarAlerta('El número de orden debe ser mayor a cero', 'error');
                return;
            }
            
            if (parseFloat(monto) <= 0) {
                mostrarAlerta('El monto debe ser mayor a cero', 'error');
                return;
            }
            
            // Verificar si ya existe una factura con el mismo número en el mismo mes
            const existeFactura = facturas.some(f => f.mes === mes && f.nro === nro);
            if (existeFactura) {
                mostrarAlerta('Ya existe una factura con este número de orden en el mes seleccionado', 'error');
                return;
            }
            
            try {
                // Mostrar loading
                const btnAgregar = document.getElementById('btnAgregar');
                const originalText = btnAgregar.innerHTML;
                btnAgregar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
                btnAgregar.disabled = true;
                
                const nuevaFactura = {
                    nro: nro,
                    empresa: empresa.trim(),
                    fecha: fecha,
                    nroFactura: nroFactura.trim(),
                    monto: parseFloat(monto),
                    mes: mes,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                console.log('📝 Guardando factura:', nuevaFactura);
                
                // Guardar en Firebase
                await db.collection('facturas').add(nuevaFactura);
                
                // Limpiar formulario
                document.getElementById('empresa').value = '';
                document.getElementById('nroFactura').value = '';
                document.getElementById('monto').value = '';
                
                // Actualizar sugerencia de número
                await actualizarSugerenciaNumero();
                
                // Recargar lista
                await cargarFacturas();
                
                mostrarAlerta('Factura agregada correctamente!');
                
            } catch (error) {
                console.error('❌ Error agregando factura:', error);
                mostrarAlerta('Error al agregar la factura: ' + error.message, 'error');
            } finally {
                // Restaurar botón
                const btnAgregar = document.getElementById('btnAgregar');
                btnAgregar.innerHTML = '<i class="fas fa-plus"></i> Agregar Factura';
                btnAgregar.disabled = false;
            }
        }
        
        // Eliminar factura
        async function eliminarFactura(id) {
            try {
                await db.collection('facturas').doc(id).delete();
                await cargarFacturas();
                cerrarModal('modalEliminar');
                mostrarAlerta('Factura eliminada correctamente');
            } catch (error) {
                console.error('❌ Error eliminando factura:', error);
                mostrarAlerta('Error al eliminar la factura: ' + error.message, 'error');
            }
        }
        
        // Marcar mes como cancelado
        async function cancelarMes(mes) {
            try {
                // En una implementación real, aquí guardarías el estado en Firebase
                // Por ahora solo cambiamos el estado localmente
                mostrarAlerta(`El mes ${formatearMes(mes)} ha sido marcado como cancelado`);
                cerrarModal('modalCancelacion');
                // Recargar para mostrar el cambio
                await cargarFacturas();
            } catch (error) {
                console.error('❌ Error cancelando mes:', error);
                mostrarAlerta('Error al cancelar el mes: ' + error.message, 'error');
            }
        }
        
        // =============================================
        // FUNCIONES DE EXPORTACIÓN
        // =============================================
        
        // Mostrar modal para exportar
        function mostrarModalExportar(mes) {
            mesAExportar = mes;
            document.getElementById('modalExportarTexto').textContent = 
                `Exportar facturas de ${formatearMes(mes)}`;
            document.getElementById('modalExportar').style.display = 'block';
        }
        
        // Exportar a PDF
        function exportarAPDF(mes) {
            const facturasDelMes = facturas.filter(f => f.mes === mes).sort((a, b) => parseInt(a.nro) - parseInt(b.nro));
            const nombreMes = formatearMes(mes);
            const total = facturasDelMes.reduce((sum, factura) => sum + parseFloat(factura.monto), 0);
            const seisPorciento = total * 0.06;
            const totalGeneral =  seisPorciento;
            
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(18);
            doc.text(`Facturas del Mes: ${nombreMes}`, 14, 15);
            
            // Tabla de facturas
            const tableColumn = ["Nro", "Empresa", "Fecha", "N° Factura", "Monto (Bs)"];
            const tableRows = [];
            
            facturasDelMes.forEach(factura => {
                const facturaData = [
                    factura.nro,
                    factura.empresa,
                    factura.fecha,
                    factura.nroFactura,
                    formatearMoneda(factura.monto)
                ];
                tableRows.push(facturaData);
            });
            
            // Añadir tabla
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 25,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [44, 62, 80] }
            });
            
            // Añadir totales
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.text(`Subtotal: ${formatearMoneda(total)}`, 14, finalY);
            doc.text(`6% sobre el total: ${formatearMoneda(seisPorciento)}`, 14, finalY + 10);
            doc.setFontSize(14);
            doc.text(`TOTAL GENERAL: ${formatearMoneda(totalGeneral)}`, 14, finalY + 25);
            
            // Guardar PDF
            doc.save(`facturas_${mes}.pdf`);
            mostrarAlerta('PDF generado correctamente');
            cerrarModal('modalExportar');
        }
        
        // Exportar a Word
        function exportarAWord(mes) {
            const facturasDelMes = facturas.filter(f => f.mes === mes).sort((a, b) => parseInt(a.nro) - parseInt(b.nro));
            const nombreMes = formatearMes(mes);
            const total = facturasDelMes.reduce((sum, factura) => sum + parseFloat(factura.monto), 0);
            const seisPorciento = total * 0.06;
            const totalGeneral = seisPorciento;
            
            let tableHTML = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" 
                      xmlns:w="urn:schemas-microsoft-com:office:word" 
                      xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="utf-8">
                    <title>Facturas ${nombreMes}</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #2c3e50; color: white; }
                        .total { font-weight: bold; margin-top: 20px; }
                    </style>
                </head>
                <body>
                    <h1>Facturas del Mes: ${nombreMes}</h1>
                    <table>
                        <tr>
                            <th>Nro</th>
                            <th>Empresa</th>
                            <th>Fecha</th>
                            <th>N° Factura</th>
                            <th>Monto (Bs)</th>
                        </tr>
            `;
            
            facturasDelMes.forEach(factura => {
                tableHTML += `
                    <tr>
                        <td>${factura.nro}</td>
                        <td>${factura.empresa}</td>
                        <td>${factura.fecha}</td>
                        <td>${factura.nroFactura}</td>
                        <td>${formatearMoneda(factura.monto)}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </table>
                    <div class="total">
                        <p>Subtotal: ${formatearMoneda(total)}</p>
                        <p>6% sobre el total: ${formatearMoneda(seisPorciento)}</p>
                        <p><strong>TOTAL GENERAL: ${formatearMoneda(totalGeneral)}</strong></p>
                    </div>
                </body>
                </html>
            `;
            
            // Crear blob y descargar
            const blob = new Blob([tableHTML], { type: 'application/msword' });
            const link = document.createElement('a');
            
            link.href = URL.createObjectURL(blob);
            link.download = `facturas_${mes}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            mostrarAlerta('Documento Word generado correctamente');
            cerrarModal('modalExportar');
        }
        
        // =============================================
        // FUNCIONES UTILITARIAS
        // =============================================
        
        // Actualizar sugerencia de número de orden
        async function actualizarSugerenciaNumero() {
            const mes = document.getElementById('mes').value;
            if (mes) {
                // Obtener el siguiente número disponible para este mes
                const facturasDelMes = facturas.filter(f => f.mes === mes);
                let siguienteNro = 1;
                
                if (facturasDelMes.length > 0) {
                    // Encontrar el número más alto y sumar 1
                    const numeros = facturasDelMes.map(f => parseInt(f.nro));
                    siguienteNro = Math.max(...numeros) + 1;
                }
                
                document.getElementById('nro').value = siguienteNro;
            }
        }
        
        // Formatear mes (ej: "2024-01" -> "Enero 2024")
        function formatearMes(mes) {
            const [anio, mesNum] = mes.split('-');
            const meses = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            return `${meses[parseInt(mesNum) - 1]} ${anio}`;
        }
        
        // Formatear moneda - MODIFICADO: "Bs" después del número
        function formatearMoneda(monto) {
            return new Intl.NumberFormat('es-BO', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(monto) + ' Bs';
        }
        
        // Funciones de modales
        function confirmarEliminar(id, nro, mes) {
            facturaAEliminar = id;
            document.getElementById('modalEliminarTexto').textContent = 
                `¿Estás seguro de que deseas eliminar la factura #${nro} del mes ${formatearMes(mes)}?`;
            document.getElementById('modalEliminar').style.display = 'block';
        }
        
        function confirmarCancelacion(mes) {
            mesACancelar = mes;
            document.getElementById('modalCancelacionTexto').textContent = 
                `¿Estás seguro de que el mes ${formatearMes(mes)} ha sido cancelado?`;
            document.getElementById('modalCancelacion').style.display = 'block';
        }
        
        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'modalEliminar') facturaAEliminar = null;
            if (modalId === 'modalCancelacion') mesACancelar = null;
            if (modalId === 'modalExportar') mesAExportar = null;
        }
        
        // =============================================
        // INICIALIZACIÓN
        // =============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Event listener para el botón de login
            document.getElementById('btnLogin').addEventListener('click', verificarPassword);
            
            // Permitir login con Enter
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verificarPassword();
                }
            });
            
            // Enfocar el campo de contraseña al cargar
            document.getElementById('passwordInput').focus();
        });
        
        // Funciones globales
        window.cerrarModal = cerrarModal;
        window.confirmarEliminar = confirmarEliminar;
        window.confirmarCancelacion = confirmarCancelacion;
        window.toggleDetalles = toggleDetalles;
        window.mostrarModalExportar = mostrarModalExportar;
        window.exportarAPDF = exportarAPDF;
        window.exportarAWord = exportarAWord;
    </script>
</body>
</html>





